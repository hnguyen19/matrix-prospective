---
title: 'Q2: how long until total resistance'
output: html_document
---

```{r, include=FALSE}

set.seed(722)
```

```{r, echo=FALSE}
RR_genotype <- 0.05 
resistant_freq  <- sqrt(RR_genotype)

SS_genotype <- (1 - resistant_freq)^2 #homozygotic susceptible

SR_genotype <- 1 - RR_genotype - SS_genotype

Sx_genotype <- 1 - RR_genotype  # homo- and heterozygotic susceptible


profile_start <- c(resistant_prop, susceptible_prop)

starting_point <-  c(10000, 0, 0, 0, 0, 0, 0, 0) #10000 seeds top soil, 0 seed deep soil,0 plants from cohorts 1 through 6
```

```{r tillage-sim2, include=FALSE}
fall_tillage <-readRDS("../2-Data/Clean/mean-post-harvest-tillage.RData")

spring_tillage <-readRDS("../2-Data/Clean/mean-pre-planting-tillage.RData")
```

### overwinter survival matrix  

```{r overwinter-sim2}
overwinter <- readRDS("../2-Data/Clean/mean-winter-seed-survival-Sosnoskie.RData")
```

### emergence matrix  

```{r emerge-sim2, echo=FALSE}
emergence <-readRDS("../2-Data/Clean/mean-emergence-prop.RData")
```

### seed survival rate and seedling to maturity success rate 

```{r survive-sim2, echo=FALSE}
summer_seed_survival <- readRDS("../2-Data/Clean/mean-summer-seed-survival-Sosnoskie.RData")

#### plant survival: literature data - named as scenario2, because scenario1 is the point-estimates from the experiment 

female_survival <- readRDS("../2-Data/Clean/mean-summer-seedling-survival-Hartzler.RData")

#### combine seed and plant survivals into one matrix with element-wise multiplication: this is not computing, but arranging using 1's as placeholders 
summer_survival <- purrr::map2(summer_seed_survival, female_survival, `*`)
```


```{r fecund-sim2, echo=FALSE}
### Scenario 1 fecundity
fecundity_scenario1 <- readRDS("../2-Data/Clean/mean-fecundity-18-cohort.RData")

### Scenario 2 fecundity
fecundity_scenario2 <- readRDS("../2-Data/Clean/mean-fecundity-19-cohort.RData")
```

```{r RR-tally}
### scalar calculation of allele frequency 
#begin 
start_prop_RR <- 0.05  # r^2 in the H-W equation
start_prop_R <- sqrt(start_prop_RR)

start_prop_S <- 1 - start_prop_R
start_prop_SS <- start_prop_S^2 # s^2 in the H-W equation

start_prop_SR = 1 - (start_prop_RR + start_prop_SS) #2rs in the H-W equation



# Assumption: 
# All the RS and SS genotypes are killed by herbicide when exposed;
# New seeds of cohorts 1 through 3: 50% RR and 50% SR, because all the SS and SR in cohorts 1 through 3 are killed, but SS and SR plants are available in cohorts 4 through 6
# Population sex ratio does not affect gamete sex ratio, meaning the female plants in the female-biased population does not make more female gamete.
# New seeds of cohorts 4 through 6 are of the same allele frequency as the original seed population : 0.05 RR and 0.95 Sx

# A matrix to pick out the RR prop after the starting_point population has completed a generation
after_corn_RR_prop <- matrix(1, nrow = 8, ncol = 8)

after_corn_RR_prop[1, 3:8] <- c(.5, .5, .5, 0.05, 0.05, 0.05)

after_corn_RR_prop[2, 2] <- 0.05
```

$$
R_n = R_0 * (1 - \frac{F\alpha}{b})^n
$$
where,  

n is the number of generation that the population is under selection pressure,  
$R_n$ is the fraction of resistant seeds after n generations,  
$R_o$ is the initial frequency of resistant seeds,  
F is the fecundity of surviving plants
$\alpha$ is the ratio of resistant versus susceptible plants that survived after a generation of exposure  
b is the number of years that a seed remains viable in the soil seedbank  

Assumptions:
In conventional herbicide treatment: 100% of the RR plants survive, but 1% of the SS plants survive
In low herbicide treatment: 50% of the RR plants survive and 50% of the SS plants survive
When no herbicide was applied: 50% of the RR plants survive and 50% of the SS plants survive


```{r rot-2yr-conv-resistance-functions, echo=FALSE}
# event sequence: seed dropped - chisel - overwinter - field cultivator - emerge - survive - new seed

# create a function 
# vec: starting seed column
# poh: post-harvest tillage
# ow: over winter seed survival
# prt: pre-planting-tillage
# em: emergence
# sv: seed survival rate and seedling to maturity success rate
# seed: fecundity

## seeds are dropped before spring tillage or before post-harvest? 

rot_2year_resistance_conv_C <- function(vec, prt_C, em_C, sv_C, seed_C, poh_C, ow_C,
                                        prt_S, em_S, sv_S, poh_S, ow_S, seed_S){
  
# corn phase resistance dynamics   

    gen1_seed_mature_pl <- sv_C %*% em_C %*% prt_C %*% vec 
    
  # mature plant block
  gen1_mature_pl <- gen1_seed_mature_pl[3:8]
  
 # seedbank block
  gen1_seed_remain_RR <- gen1_seed_mature_pl[1:2] * 0.05
  gen1_seed_remain_Sx <-  gen1_seed_mature_pl[1:2] -  gen1_seed_remain_RR 
  

  gen1_new_seed <- gen1_mature_pl*seed_C[1,3:8]
  gen1_new_seed_RR <- gen1_new_seed * c(0.5, 0.5, 0.5, 0.05, 0.05, 0.05)
  gen1_new_seed_Sx <- gen1_new_seed - gen1_new_seed_RR
  
  # tally the number of RR seeds and Sx seeds at the end of generation 1
  # RR seeds
  gen1_seed_RR_top <- sum(gen1_new_seed_RR) + gen1_seed_remain_RR[1] 
  
  gen1_seed_RR_bottom <- gen1_seed_remain_RR[2] # new seeds in the top 2cm stratum only
  
  gen1_seed_RR_pre_harvest <- c(gen1_seed_RR_top, gen1_seed_RR_bottom, rep(0,6))
  
  until_gen2_seed_RR <- ow_C %*% poh_C %*%  gen1_seed_RR_pre_harvest 
  
  #Sx seeds
   gen1_seed_Sx_top <- sum(gen1_new_seed_Sx) + gen1_seed_remain_Sx[1] 
  
  gen1_seed_Sx_bottom <- gen1_seed_remain_Sx[2] # new seeds in the top 2cm stratum only
  
  gen1_seed_Sx_pre_harvest  <- c( gen1_seed_Sx_top, gen1_seed_Sx_bottom, rep(0, 6))
  
  
  until_gen2_seed_Sx <- ow_C %*% poh_C %*%  gen1_seed_Sx_pre_harvest 
  
#  check the cumulative percentage upto the beginning of the soybean phase
  
  until_gen2_seed <- until_gen2_seed_RR +  until_gen2_seed_Sx 
  
  until_gen2_prop_RR <- until_gen2_seed_RR[1:2]/until_gen2_seed[1:2]
  
   until_gen2_prop_Sx <- until_gen2_seed_Sx[1:2]/until_gen2_seed[1:2]
  
#  until_gen2_profile <- c(until_gen2_prop_RR, until_gen2_prop_Sx)
  
#  until_gen2_profile <- list(until_gen2_prop_RR, until_gen2_prop_Sx) 
#   names(until_gen2_profile) <- c("RR","Sx")
   
   #after the first winter, about 50% of the seedbank is RR
   
   # Soybean dynamics: apply the same chain of matrix multiplication on the RR and Sx vectors
   # until_gen2_seed_RR and until_gen2_seed_Sx
   
 
     gen2_seed_mature_pl <- sv_S %*% em_S %*% prt_S %*% until_gen2_seed
   
   #  # seedbank block
  gen2_seed_remain_RR <- gen2_seed_mature_pl[1:2] * until_gen2_prop_RR #% non-germinated seeds that are RR
  
  gen2_seed_remain_Sx <-  gen2_seed_mature_pl[1:2] -  gen2_seed_remain_RR #% non-germinated seeds that are Sx
  
  # mature plant block

    gen2_mature_pl <- gen2_seed_mature_pl[3:8]
     
     gen2_new_seed <- gen2_mature_pl*seed_S[1,3:8]
  
  gen2_new_seed_RR <- gen2_new_seed * c(0.5, 0.5, 0.5, 0.05, 0.05, 0.05)
  
  gen2_new_seed_Sx <- gen2_new_seed - gen2_new_seed_RR
  
  # tally the number of RR seeds and Sx seeds at the end of generation 2
  # RR seeds
  gen2_seed_RR_top <- sum(gen2_new_seed_RR) + gen2_seed_remain_RR[1] 
  gen2_seed_RR_bottom <- gen2_seed_remain_RR[2] # new seeds in the top 2cm stratum only
  
  gen2_seed_RR_pre_harvest <- c(gen2_seed_RR_top, gen2_seed_RR_bottom, rep(0,6))
  
  end_gen2_seed_RR <- ow_C %*% poh_C %*%  gen2_seed_RR_pre_harvest 
  
  #Sx seeds
   gen2_seed_Sx_top <- sum(gen2_new_seed_Sx) + gen2_seed_remain_Sx[1] 
  
  gen2_seed_Sx_bottom <- gen2_seed_remain_Sx[2] # new seeds in the top 2cm stratum only
  gen2_seed_Sx_pre_harvest  <- c( gen2_seed_Sx_top, gen2_seed_Sx_bottom, rep(0, 6))
  
  
  end_gen2_seed_Sx <- ow_C %*% poh_C %*%  gen2_seed_Sx_pre_harvest 
  
   end_gen2_profile <- c(end_gen2_seed_RR, end_gen2_seed_Sx)
   
    end_gen2_total_seed <- end_gen2_seed_RR + end_gen2_seed_Sx 
    
   end_gen2_prop_RR <- end_gen2_seed_RR[1:2]/end_gen2_total_seed[1:2]
    
   end_gen2_prop_Sx <- end_gen2_seed_Sx[1:2]/end_gen2_total_seed[1:2]
   
  end_gen2_seed_RR
}


```


```{r rot-2yr-resistance-R-sim}
##### with corn under conventional weed management {-}
t <- 100
R_2yr_conv <- list() # blank data frame to save loop output 
R_2yr_conv[[1]] <- starting_point 


for (i in 1:t) { 
  R_2yr_conv[[i]] =  rot_2year_resistance_conv_C(starting_point,
                           poh_C = fall_tillage$C2_conv,
                              ow_C = overwinter$C2_conv,
                              prt_C  = spring_tillage$C2_conv,
                              em_C  = emergence$C2_conv,
                              sv_C = summer_survival$C2_conv,
                              seed_C = fecundity_scenario1$C2_conv,
                            #soybean dynamics   
                              poh_S = fall_tillage$S2_conv,
                              ow_S = overwinter$S2_conv,
                              prt_S  = spring_tillage$S2_conv,
                              em_S  = emergence$S2_conv,
                              sv_S = summer_survival$S2_conv,
                              seed_S = fecundity_scenario1$S2_conv)
}
```


    # after corn
    
    after_corn  <- seed_C %*% seed_mature_pl # total seeds

# spring_res
  # seed_mature_pl_RR
    

    after_corn_RR_mult <-  after_corn_RR_prop * seed_C 
    
    after_corn_RR <- (after_corn_RR_prop * seed_C) %*% seed_mature_pl ## RR only
    
    after_corn_Sx =  after_corn -  after_corn_RR  # Sx 
}


rot_2year_resistance_conv_S <- function(){
# soybean dynamics    
    # All the RR seedlings in soy survived
    sv_S_RR <- sv_S
    
    diag(sv_S_RR)[3:8] <- 1
    
    seed_mature_pl_S_RR <- sv_S_RR %*% em_S %*% prt_S %*%  ow_S %*%  poh_S %*% after_corn_RR
    
    # All the Sx seedlings in soy died 
    
}





```{r }
rot_2year_resistance_conv_S <- function(vec, poh_C, ow_C, prt_C, em_C, sv_C, seed_C,
                           poh_S, ow_S, prt_S, em_S, sv_S, seed_S){
  
# corn phase resistance dynamics   
    spring_seed_col <- ow_C %*% poh_C %*% vec # 
    
# R/S density before pre-planting tillage

#spring_res <-  spring_seed_col * resistant_prop

 spring_sus <- spring_seed_col * susceptible_prop

 spring_sus 

}
```


```{r rot-2yr-resistance-S-sim}
rot_2year_resistance_conv_S(starting_point,
                           poh_C = fall_tillage$C2_conv,
                              ow_C = overwinter$C2_conv,
                              prt_C  = spring_tillage$C2_conv,
                              em_C  = emergence$C2_conv,
                              sv_C = summer_survival$C2_conv,
                              seed_C = fecundity18$C2_conv,
                            #soybean dynamics   
                              poh_S = fall_tillage$S2_conv,
                              ow_S = overwinter$S2_conv,
                              prt_S  = spring_tillage$S2_conv,
                              em_S  = emergence$S2_conv,
                              sv_S = summer_survival$S2_conv,
                              seed_S = fecundity18$S2_conv)
```

   after_soy <- seed_S %*% sv_S %*% em_S %*% prt_S %*%  ow_S %*%  poh_S %*% after_corn 

   after_soy
   
    after_corn <- seed_C %*% sv_C %*% em_C %*% prt_C %*%  ow_C %*% 
