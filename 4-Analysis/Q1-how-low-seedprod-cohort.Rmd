---
title: 'Q1: how low is seed production allowed'
output: html_document 
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(data.table)
library(readr)
library(magrittr) # for %<>%
library(nlme) # for gls
library(emmeans) # for joint_tests
library(patchwork)
set.seed(722)
```

### first seed column
```{r}
starting_point <-  c(0, 1000, 0) #0 plants, 1000 seeds top soil, 0 seed deep soil
```


### tillage matrices  

```{r tillage-sim}
notill <- diag(1,2)

moldboard <- matrix(c(0.017857143,	0.072961329, 0.982142857,	0.927038671), byrow = TRUE, nrow = 2)

chisel <- matrix(c(0.589108911,	0.103123159, 0.410891089,	0.896876841), byrow = TRUE, nrow = 2) 

field_cultivator <- matrix(c(0.594855305,	0.149901381, 0.405144695,	0.850098619), byrow = TRUE, nrow = 2)
```

### overwinter survival matrix  

```{r overwinter-sim}
overwinter <- matrix(c(0.6576641,	0, 0,	0.7371141), byrow = TRUE, nrow = 2)
```

### emergence matrix  

```{r emerge-sim, echo=FALSE}
emergence <-readRDS("../2-Data/Clean/mean-emergence-prop.RData")
emergence$C2_conv
```


### seed survival rate and seedling to maturity success rate 

```{r survive-sim, echo=FALSE}
summer_seed_survival <- readRDS("../2-Data/Clean/mean-summer-seed-survival-Sosnoskie.RData")

#### plant survival: literature data - named as scenario2, because scenario1 is the point-estimates from the experiment 
#female_survival <- readRDS("../2-Data/Clean/female-survival-rate-cohort-equal.RData")

female_survival <- readRDS("../2-Data/Clean/mean-summer-seedling-survival-Hartzler.RData")

#### combine seed and plant survivals into one matrix with element-wise multiplication: this is not computing, but arranging using 1's as placeholders 
summer_survival <- purrr::map2(summer_seed_survival, female_survival, `*`)

summer_survival$C2_conv
```

### fecundity manipulation plan  

```{r fecund-sim}
# First step: use a cumulative fecundity of all cohorts as `
#new_seeds_total`=  mature_plant_total * fecundity_sim
# change fecundity_sim  to get lambda as close to 1 as possible 

# Focus next: manipulate cohorts 1 and 2 in corn and soybean fecundity only because 1) these cohorts are more likely exposed to control measures and 2) they have higher survival rates than cohorts 3+ 

# cohort 3+ fecundity: estimated fecundity as in population projection 

# Final goal: flatten the fecundity distribution curve in corn and soybean to see seed production "allowance" in cohorts 1 and 2

### find good pairs of mean and sd for rlnorm 

# bring over the seed - biomass relationship from AMATA-fecundity, seed production allowance in A4 is a good start because lambda = 1.03
fecundity18 <- read_csv("../2-Data/Clean/fecundity_18.csv", 
    col_types = cols(Biomass = col_number(), 
        Seed = col_number()), na = "empty")

fecundity18$Crop_ID <- factor(fecundity18$Crop_ID, 
                              levels = c("C2", "S2",
                                         "C3", "S3", "O3",
                                         "C4", "S4", "O4", "A4"))

# Make sure that Block, Crop ID, Corn_weed_management, and bt are factors
fecundity18  <- fecundity18   %<>%
  mutate_at(c("Block","Crop_ID","Corn_weed_management", "bt"),funs(factor(.)))

# sb stands for seed and biomass
fecundity18_sb <- fecundity18[complete.cases(fecundity18$Seed, fecundity18$Biomass), ]

fecundity18_sb_ln <- fecundity18_sb %>% 
  mutate(ln_Biomass = log(Biomass + 0.005),
         ln_Seed = log(Seed + 1)) %>%
  group_by(Crop_ID, Corn_weed_management) %>% # pool all plants from the same CropID x Corn weed mgt
  mutate(quantile_Biomass = ntile(ln_Biomass , 6),
         quantile_Seed = ntile(ln_Seed, 6)) %>%
  dplyr::mutate(tag = ifelse(quantile_Biomass == quantile_Seed,  "matched", "mismatched"))  # check if Biomass and Seed quantiles are aligned: ONLY 202 are matched.
```


```{r sb-hist}
## since biomass is used to estimate fecundity, use biomass bins to partition data
fecundity18_sb_ln  %>% 
  ggplot(aes(x = ln_Biomass)) + 
  facet_grid(Crop_ID ~ Corn_weed_management) +
  geom_histogram(binwidth = 1.5) 

# make a wide table 

#fecundity18_sb_wide <- fecundity18_sb %>% 
#  mutate(cut_ = )
```


```{r biom-boxp}
## side by size box plot

biom_boxp <- fecundity18_sb_ln  %>% 
  ggplot(aes(x = ln_Biomass)) + 
  facet_grid(Crop_ID ~ Corn_weed_management) +
  geom_boxplot() +
  theme(axis.ticks.y = element_blank(),
        axis.text.y = element_blank())


seed_boxp <-fecundity18_sb_ln  %>% 
  ggplot(aes(x = ln_Seed)) + 
  facet_grid(Crop_ID ~ Corn_weed_management) +
  geom_boxplot() +
  theme(axis.ticks.y = element_blank(),
        axis.text.y = element_blank())

biom_boxp | seed_boxp

```
```
```{r biom-seed-eq-copy}
allcrops.biom.seed.gls <- gls(log(Seed+1) ~ Block + 
                                log(Biomass + 0.005) + 
                                Crop_ID + Corn_weed_management +
                      Crop_ID:Corn_weed_management +
                      Crop_ID:log(Biomass + 0.005) +
                        Corn_weed_management:log(Biomass + 0.005) +
                      Crop_ID:Corn_weed_management:log(Biomass + 0.005),
  correlation=corCompSymm(form= ~1 | bt), #identifies each treatment within block
  data=fecundity18_sb)


sb_emm_6bin <- emmeans(allcrops.biom.seed.gls ,
        ~ Crop_ID * Corn_weed_management | Biomass,
        at = list(Biomass = c( 0.04, 0.28, 2.28, 18.36, 148.41, 1187.97)))

# expand the regression line, focused on the lower end  


```

#### 1000 seeds at t=1, 600 at t=2 and beyond

```{r corn1}
# event sequence: seed dropped - chisel - overwinter - field cultivator - emerge - survive - new seed

# create a function 
# vec: starting seed column
# poh: post-harvest tillage
# ow: over winter seed survival
# prt: pre-planting-tillage
# em: emergence
# sv: seed survival rate and seedling to maturity success rate

corn1 <- function(vec, poh, ow, prt, em, sv){
   early_summer_sb <- prt %*%  ow %*%  poh %*% vec # post-harvest through pre-planting

   mature_plant_total <-  early_summer_sb[1]*em[3,1]*sv[[3,3]] + 
     early_summer_sb[1]*em[4,1]*sv[[4,4]] +
     early_summer_sb[1]*em[5,1]*sv[[5,5]] +
     early_summer_sb[1]*em[6,1]*sv[[6,6]] + 
     early_summer_sb[1]*em[7,1]*sv[[7,7]] + 
     early_summer_sb[1]*em[8,1]*sv[[8,8]]   # emerge through maturity 
   
    new_seeds_total <-  mature_plant_total * rlnorm(1, 6.802395, 4.49981)
  
    summer_till_harvest_sb <- em[1:2,1:2] %*% early_summer_sb  # dormant seeds dynamics until new seeds
    
    post_harvest_sb <- c(new_seeds_total+summer_till_harvest_sb[1], summer_till_harvest_sb[2])
   
   c(0, post_harvest_sb) 
}
```


```{r c2-conv-sim1}

t <- 30
N <- list() # blank dataframe to save loop output 
## Calculate N0
N0 <- corn1(vec = starting_point[2:3], 
   poh = chisel, 
   ow = overwinter,
   prt = field_cultivator,
   em = emergence[["C2_conv"]],
   sv = summer_survival[["C2_conv"]])

 N[[1]] <- N0


#loop over the "corn" function for C2-conv for "t" times 

for (i in 2:t) { 
    N[[i]] = corn1(vec = N[[i-1]][2:3],
                  poh = chisel, 
                  ow = overwinter,
                  prt = field_cultivator,
                  em = emergence[["C2_conv"]],
                  sv = summer_survival[["C2_conv"]])
}
 
N_df <- N %>% 
  unlist(recursive = FALSE) %>%
  data.frame() %>%
    dplyr::rename(no_ = ".") %>%
  dplyr::mutate(category = rep(c("plant", "seed_top", "seed_bottom"),t)) %>%
    filter(category != "plant") %>%
 # dplyr::select(!rowname) %>%
  tidyr::pivot_wider(names_from = category,
                     values_from = no_,
                     values_fn = list) %>% 
    unnest(cols = everything() ) %>%
    mutate(time_step = seq(1:t)) %>%
  pivot_longer(!time_step, names_to = "stratum", values_to = "no_")
  

```

```{r sim1-plot}
N_df %>%
  ggplot() +
   aes(x = time_step, y = log(no_), group = stratum) +
  geom_line(aes(y = log(no_), linetype =  stratum)) +
  geom_point(aes(y  = log(no_), shape =  stratum))
```

#### 1000 seeds at t=1, 1200 at t=2 and beyond

```{r corn2}
# to test mechanism
# event sequence: seed dropped - chisel - overwinter - field cultivator - emerge - survive - new seed

# create a function 
# em, sv, fe

corn2 <- function(vec, poh, ow, prt, em, sv){
   early_summer_sb <- prt %*%  ow %*%  poh %*% vec # post-harvest through pre-planting

   mature_plant_total <-  early_summer_sb[1]*em[3,1]*sv[[3,3]] + 
     early_summer_sb[1]*em[4,1]*sv[[4,4]] +
     early_summer_sb[1]*em[5,1]*sv[[5,5]] +
     early_summer_sb[1]*em[6,1]*sv[[6,6]] + 
     early_summer_sb[1]*em[7,1]*sv[[7,7]] + 
     early_summer_sb[1]*em[8,1]*sv[[8,8]]   # emerge through maturity 
   
    new_seeds_total <-  mature_plant_total * sample(rnorm(1000, 1200, 205), 1) #whole-population annual fecundity
  
    summer_till_harvest_sb <- em[1:2,1:2] %*% early_summer_sb  # dormant seeds dynamics until new seeds
    
    post_harvest_sb <- c(new_seeds_total+summer_till_harvest_sb[1], summer_till_harvest_sb[2]) #add the newly produced seeds to the top layer seed only; vertical redistribution start again at the next time step.
   
   c(0, post_harvest_sb) # emerged not subtracted yet 
}
```


```{r c2-conv-sim2}

M <- list() # blank dataframe to save loop output 
## Calculate M0
M0 <- corn2(vec = starting_point[2:3], 
   poh = chisel, 
   ow = overwinter,
   prt = field_cultivator,
   em = emergence[["C2_conv"]],
   sv = summer_survival[["C2_conv"]])

 M[[1]] <- M0


#loop over the "corn" function for C2-conv for "t" times 

for (i in 2:t) { 
    M[[i]] = corn2(vec = M[[i-1]][2:3],
                  poh = chisel, 
                  ow = overwinter,
                  prt = notill,
                  em = emergence[["C2_conv"]],
                  sv = summer_survival[["C2_conv"]])
}
 
M_df <- M %>% 
  unlist(recursive = FALSE) %>%
  data.frame() %>%
    dplyr::rename(no_ = ".") %>%
  dplyr::mutate(category = rep(c("plant", "seed_top", "seed_bottom"),t)) %>%
    filter(category != "plant") %>%
 # dplyr::select(!rowname) %>%
  tidyr::pivot_wider(names_from = category,
                     values_from = no_,
                     values_fn = list) %>% 
    unnest(cols = everything() ) %>%
    mutate(time_step = seq(1:t)) %>%
  pivot_longer(!time_step, names_to = "stratum", values_to = "no_")
  

```

```{r sim2-plot}
M_df %>%
  ggplot() +
   aes(x = time_step, y = no_, group = stratum) +
  geom_line(aes(y =  no_, linetype =  stratum)) +
  geom_point(aes(y  = no_, shape =  stratum))
```

#### 1000 seeds at t=1, 1005 at t=2 and beyond

```{r corn3}
# to test mechanism
# event sequence: seed dropped - chisel - overwinter - field cultivator - emerge - survive - new seed

# create a function 
# em, sv, fe

corn3 <- function(vec, poh, ow, prt, em, sv){
   early_summer_sb <- prt %*%  ow %*%  poh %*% vec # post-harvest through pre-planting

   mature_plant_total <-  early_summer_sb[1]*em[3,1]*sv[[3,3]] + 
     early_summer_sb[1]*em[4,1]*sv[[4,4]] +
     early_summer_sb[1]*em[5,1]*sv[[5,5]] +
     early_summer_sb[1]*em[6,1]*sv[[6,6]] + 
     early_summer_sb[1]*em[7,1]*sv[[7,7]] + 
     early_summer_sb[1]*em[8,1]*sv[[8,8]]   # emerge through maturity 
   
    new_seeds_total <-  mature_plant_total *  sample(rnorm(1000, 1005, 60), 1)
  
    summer_till_harvest_sb <- em[1:2,1:2] %*% early_summer_sb  # dormant seeds dynamics until new seeds
    
    post_harvest_sb <- c(new_seeds_total+summer_till_harvest_sb[1], summer_till_harvest_sb[2])
   
   c(0, post_harvest_sb) # emerged not subtracted yet 
}
```


```{r c2-conv-sim3}

P <- list() # blank dataframe to save loop output 
  ## Calculate P0
P0 <- corn3(vec = starting_point[2:3], 
   poh = chisel, 
   ow = overwinter,
   prt = field_cultivator,
   em = emergence[["C2_conv"]],
   sv = summer_survival[["C2_conv"]])

P[[1]] <- P0


#loop over the "corn" function for C2-conv for "t" times 

for (i in 2:t) { 
    P[[i]] = corn3(vec = P[[i-1]][2:3],
                  poh = chisel, 
                  ow = overwinter,
                  prt = field_cultivator,
                  em = emergence[["C2_conv"]],
                  sv = summer_survival[["C2_conv"]])
}
 
P_df <- M %>% 
  unlist(recursive = FALSE) %>%
  data.frame() %>%
    dplyr::rename(no_ = ".") %>%
  dplyr::mutate(category = rep(c("plant", "seed_top", "seed_bottom"),t)) %>%
    filter(category != "plant") %>%
 # dplyr::select(!rowname) %>%
  tidyr::pivot_wider(names_from = category,
                     values_from = no_,
                     values_fn = list) %>% 
    unnest(cols = everything() ) %>%
    mutate(time_step = seq(1:t)) %>%
  pivot_longer(!time_step, names_to = "stratum", values_to = "no_")
  

```

```{r sim3-plot}
P_df %>%
  ggplot() +
   aes(x = time_step, y = no_, group = stratum) +
  geom_line(aes(y =  no_, linetype =  stratum)) +
  geom_point(aes(y  = no_, shape =  stratum))

```