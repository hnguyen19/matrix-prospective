---
title: 'Q1: how low is seed production allowance - 2 year rotation'
output: html_document 
---

## General pattern: In a corn monoculture, aiming at 945 seeds/plant (sd on natural logarithm scale under 0.86) shall keep the original population of 1000 seeds per meter squared stable.

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(data.table)
library(readr)
library(magrittr) # for %<>%
library(nlme) # for gls
library(emmeans) # for joint_tests
library(patchwork)
library(popbio)
set.seed(722)
```

### first seed column
```{r}
starting_point <-  c(10000, 0, 0, 0, 0, 0, 0, 0) #10000 seeds top soil, 0 seed deep soil,0 plants from cohorts 1 through 6
```


### tillage matrices  

```{r tillage-sim}
fall_tillage <-readRDS("../2-Data/Clean/mean-post-harvest-tillage.RData")

spring_tillage <-readRDS("../2-Data/Clean/mean-pre-planting-tillage.RData")
```

### overwinter survival matrix  

```{r overwinter-sim}
overwinter <- readRDS("../2-Data/Clean/mean-winter-seed-survival-Sosnoskie.RData")
```

### emergence matrix  

```{r emerge-sim, echo=FALSE}
emergence <-readRDS("../2-Data/Clean/mean-emergence-prop.RData")
emergence$C2_conv
```


### seed survival rate and seedling to maturity success rate 

```{r survive-sim, echo=FALSE}
summer_seed_survival <- readRDS("../2-Data/Clean/mean-summer-seed-survival-Sosnoskie.RData")

#### plant survival: literature data - named as scenario2, because scenario1 is the point-estimates from the experiment 
#female_survival <- readRDS("../2-Data/Clean/female-survival-rate-cohort-equal.RData")

female_survival <- readRDS("../2-Data/Clean/mean-summer-seedling-survival-Hartzler.RData")

#### combine seed and plant survivals into one matrix with element-wise multiplication: this is not computing, but arranging using 1's as placeholders 
summer_survival <- purrr::map2(summer_seed_survival, female_survival, `*`)

summer_survival$C2_conv
```

### fecundity manipulation plan  

```{r fecund-sim}
# First step: use a cumulative fecundity of all cohorts as `
#new_seeds_total`=  mature_plant_total * fecundity_sim
# change fecundity_sim  to get lambda as close to 1 as possible 

# Focus next: manipulate cohorts 1 and 2 in corn and soybean fecundity only because 1) these cohorts are more likely exposed to control measures and 2) they have higher survival rates than cohorts 3+ 

# cohort 3+ fecundity: estimated fecundity as in population projection 

# Final goal: flatten the fecundity distribution curve in corn and soybean to see seed production "allowance" in cohorts 1 and 2

### find good pairs of mean and sd for rlnorm in Q1-fecund-prep

fecundity18 <- readRDS("../2-Data/Clean/mean-fecundity-18-cohort.RData")
```



#### 2-year rotation with corn under conventional weed management {-}

at t = 1: 10000 seeds, cohorts 1 through 3:  rlnorm(1, 3.09, 1.13)

```{r rot-2yr-conv}
# event sequence: seed dropped - chisel - overwinter - field cultivator - emerge - survive - new seed

# create a function 
# vec: starting seed column
# poh: post-harvest tillage
# ow: over winter seed survival
# prt: pre-planting-tillage
# em: emergence
# sv: seed survival rate and seedling to maturity success rate
# poh_S, ow_S, prt_S, em_S, sv_S
rot_2year_conv <- function(vec, poh_C, ow_C, prt_C, em_C, sv_C, 
                           poh_S, ow_S, prt_S, em_S, sv_S){
  
  seed_C <- fecundity18$C2_conv
  seed_C[1,3] <- rlnorm(1, 3.09, 1.13)
  seed_C[1,4] <- rlnorm(1, 3.09, 1.13)
  seed_C[1,5] <- rlnorm(1, 3.09, 1.13) # original data partitioned into 12 bins
#  seed_C[1,6] <- rlnorm(1, 3.66, 1.44) #original data partitioned into 6 bins

  

  
  seed_S <- fecundity18$S2_conv
  seed_S[1,3] <- rlnorm(1, 3.09, 1.13)
  seed_S[1,4] <- rlnorm(1, 3.09, 1.13)
  seed_S[1,5] <- rlnorm(1, 3.09, 1.13)
#  seed_S[1,6] <- rlnorm(1, 3.66, 1.44)

    
   after_corn <- seed_C %*% sv_C %*% em_C %*% prt_C %*%  ow_C %*%  poh_C %*% vec # corn phase dynamics

   after_soy <- seed_S %*% sv_S %*% em_S %*% prt_S %*%  ow_S %*%  poh_S %*% after_corn # soybean phase dynamics

#  full_cycle <-  seed_S %*% sv_S %*% em_S %*% prt_S %*%  ow_S %*%  poh_S %*% seed_C %*% sv_C %*% em_C %*% prt_C %*%  ow_C %*%  poh_C
  
#  lambda_cycle <- popbio::lambda(full_cycle)
  
#  lambda_cycle_annualized <- sqrt(lambda_cycle)
 
#  c(lambda_cycle,lambda_cycle_annualized)
   
   after_soy
}
```

```{r 2yr-conv-sim1}

t <- 5000
N_2yr_conv <- list() # blank dataframe to save loop output 
## Calculate N0
N0_2yr_conv  <- rot_2year_conv(vec = starting_point, 
#corn dynamics
   poh_C = fall_tillage$C2_conv,
   ow_C = overwinter$C2_conv,
   prt_C  = spring_tillage$C2_conv,
   em_C  = emergence$C2_conv,
   sv_C = summer_survival$C2_conv,

#soybean dynamics   
  poh_S = fall_tillage$S2_conv,
   ow_S = overwinter$S2_conv,
   prt_S  = spring_tillage$S2_conv,
   em_S  = emergence$S2_conv,
   sv_S = summer_survival$S2_conv)

# N0

 N_2yr_conv[[1]] <- N0_2yr_conv 


#loop over the "corn" function for C2-conv for "t" times 

for (i in 2:t) { 
    N_2yr_conv[[i]] = rot_2year_conv(vec = N_2yr_conv[[i-1]],
                  poh_C = fall_tillage$C2_conv,
   ow_C = overwinter$C2_conv,
   prt_C  = spring_tillage$C2_conv,
   em_C  = emergence$C2_conv,
   sv_C = summer_survival$C2_conv,

#soybean dynamics   
  poh_S = fall_tillage$S2_conv,
   ow_S = overwinter$S2_conv,
   prt_S  = spring_tillage$S2_conv,
   em_S  = emergence$S2_conv,
   sv_S = summer_survival$S2_conv)
}

N_2yr_conv_df <-  N_2yr_conv %>% 
  unlist(recursive = FALSE) %>%
  data.frame() %>%
    dplyr::rename(counts = ".") %>%
  dplyr::mutate(category = rep(c("seed_top", "seed_bottom", "cohort_1", "cohort_2", "cohort_3", "cohort_4", "cohort_5", "cohort_6"),t)) %>%
    filter(category %in% c("seed_top", "seed_bottom")) %>%
 # dplyr::select(!rowname) %>%
 # tidyr::pivot_wider(names_from = category,
#                    values_from = no_,
#                     values_fn = list) %>% 
    unnest(cols = everything() ) %>%
    mutate(cycle_no = rep(1:t, each = 2)) %>%
  group_by(category) %>%
  mutate(lambda_cycle = counts/lag(counts),
         lambda_annualized = sqrt(lambda_cycle)) %>%
    na.omit()
```
 

#### 2-year rotation with corn under conventional weed management {-}

```{r rot-2yr-low}
# event sequence: seed dropped - chisel - overwinter - field cultivator - emerge - survive - new seed

# create a function 
# vec: starting seed column
# poh: post-harvest tillage
# ow: over winter seed survival
# prt: pre-planting-tillage
# em: emergence
# sv: seed survival rate and seedling to maturity success rate
# poh_S, ow_S, prt_S, em_S, sv_S
rot_2year_low <- function(vec, poh_C, ow_C, prt_C, em_C, sv_C, 
                           poh_S, ow_S, prt_S, em_S, sv_S){
  
  seed_C <- fecundity18$C2_low
  seed_C[1,3] <- rlnorm(1, 5.11, 0.75)
  seed_C[1,4] <- rlnorm(1, 4.02, 0.94)
  seed_C[1,5] <- rlnorm(1, 4.02, 0.94) # original data partitioned into 12 bins
#  seed_C[1,6] <- rlnorm(1, 3.66, 1.44) #original data partitioned into 6 bins


  
  seed_S <- fecundity18$S2_low
  seed_S[1,3] <- rlnorm(1, 5.11, 0.75)
  seed_S[1,4] <- rlnorm(1, 4.02, 0.94)
  seed_S[1,5] <- rlnorm(1, 4.02, 0.94)
#  seed_S[1,6] <- rlnorm(1, 3.66, 1.44)

    
   after_corn <- seed_C %*% sv_C %*% em_C %*% prt_C %*%  ow_C %*%  poh_C %*% vec # corn phase dynamics

   after_soy <- seed_S %*% sv_S %*% em_S %*% prt_S %*%  ow_S %*%  poh_S %*% after_corn # soybean phase dynamics

   after_soy
}
```
 
 
```{r 2yr-low-sim1}
N_2yr_low <- list() # blank dataframe to save loop output 
## Calculate N0
N0_2yr_low  <- rot_2year_low(vec = starting_point, 
#corn dynamics
   poh_C = fall_tillage$C2_low,
   ow_C = overwinter$C2_low,
   prt_C  = spring_tillage$C2_low,
   em_C  = emergence$C2_low,
   sv_C = summer_survival$C2_low,

#soybean dynamics   
  poh_S = fall_tillage$S2_low,
   ow_S = overwinter$S2_low,
   prt_S  = spring_tillage$S2_low,
   em_S  = emergence$S2_low,
   sv_S = summer_survival$S2_low)

# N0

 N_2yr_low[[1]] <- N0_2yr_low


#loop over the "corn" function for C2-conv for "t" times 

for (i in 2:t) { 
    N_2yr_low[[i]] = rot_2year_low(vec = N_2yr_low[[i-1]],
                  poh_C = fall_tillage$C2_low,
   ow_C = overwinter$C2_low,
   prt_C  = spring_tillage$C2_low,
   em_C  = emergence$C2_low,
   sv_C = summer_survival$C2_low,

#soybean dynamics   
  poh_S = fall_tillage$S2_low,
   ow_S = overwinter$S2_low,
   prt_S  = spring_tillage$S2_low,
   em_S  = emergence$S2_low,
   sv_S = summer_survival$S2_low)
}

N_2yr_low_df <-  N_2yr_low %>% 
  unlist(recursive = FALSE) %>%
  data.frame() %>%
    dplyr::rename(counts = ".") %>%
  dplyr::mutate(category = rep(c("seed_top", "seed_bottom", "cohort_1", "cohort_2", "cohort_3", "cohort_4", "cohort_5", "cohort_6"),t)) %>%
    filter(category %in% c("seed_top", "seed_bottom")) %>%
 # dplyr::select(!rowname) %>%
 # tidyr::pivot_wider(names_from = category,
#                    values_from = no_,
#                     values_fn = list) %>% 
    unnest(cols = everything() ) %>%
    mutate(cycle_no = rep(1:t, each = 2)) %>%
  group_by(category) %>%
  mutate(lambda_cycle = counts/lag(counts),
         lambda_annualized = sqrt(lambda_cycle)) %>%
    na.omit()

View(N_2yr_low_df)
```
  
#### 3-year rotation with corn under conventional weed management {-}

at t = 1: 10000 seeds, cohorts 1 through 3:  rlnorm(1, 3.09, 1.13)

```{r rot-3yr-conv}
rot_3year_conv <- function(vec, poh_C, ow_C, prt_C, em_C, sv_C, 
                           poh_S, ow_S, prt_S, em_S, sv_S,
                           poh_O, ow_O, prt_O, em_O, sv_O){
  
  seed_C <- fecundity18$C3_conv
  seed_C[1,3] <- rlnorm(1, 3.09, 1.13)
  seed_C[1,4] <- rlnorm(1, 3.09, 1.13)
  seed_C[1,5] <- rlnorm(1, 3.09, 1.13) 

  
  seed_S <- fecundity18$S3_conv
  seed_S[1,3] <- rlnorm(1, 3.09, 1.13)
  seed_S[1,4] <- rlnorm(1, 3.09, 1.13)
  seed_S[1,5] <- rlnorm(1, 3.09, 1.13)


  seed_O <- fecundity18$O3_conv
  
   after_corn <- seed_C %*% sv_C %*% em_C %*% prt_C %*%  ow_C %*%  poh_C %*% vec # corn phase dynamics

   after_soy <- seed_S %*% sv_S %*% em_S %*% prt_S %*%  ow_S %*%  poh_S %*% after_corn # soybean phase dynamics

after_oat <- seed_O %*% sv_O %*% em_O %*% prt_O %*%  ow_O %*%  poh_O %*% after_soy # soybean phase dynamics
   
  after_oat
}
```

```{r 3yr-conv-sim1}

N_3yr_conv <- list() # blank dataframe to save loop output 
## Calculate N0
N0_3yr_conv  <- rot_3year_conv(vec = starting_point, 
#corn dynamics
   poh_C = fall_tillage$C3_conv,
   ow_C = overwinter$C3_conv,
   prt_C  = spring_tillage$C3_conv,
   em_C  = emergence$C3_conv,
   sv_C = summer_survival$C3_conv,

#soybean dynamics   
  poh_S = fall_tillage$S3_conv,
   ow_S = overwinter$S3_conv,
   prt_S  = spring_tillage$S3_conv,
   em_S  = emergence$S3_conv,
   sv_S = summer_survival$S3_conv,

#oat dynamics   
  poh_O = fall_tillage$O3_conv,
   ow_O = overwinter$O3_conv,
   prt_O  = spring_tillage$O3_conv,
   em_O  = emergence$O3_conv,
   sv_O = summer_survival$O3_conv)

# N0

 N_3yr_conv[[1]] <- N0_3yr_conv 


for (i in 2:t) { 
    N_3yr_conv[[i]] = rot_3year_conv(vec = N_3yr_conv[[i-1]],
                  poh_C = fall_tillage$C3_conv,
   ow_C = overwinter$C3_conv,
   prt_C  = spring_tillage$C3_conv,
   em_C  = emergence$C3_conv,
   sv_C = summer_survival$C3_conv,

#soybean dynamics   
  poh_S = fall_tillage$S3_conv,
   ow_S = overwinter$S3_conv,
   prt_S  = spring_tillage$S3_conv,
   em_S  = emergence$S3_conv,
   sv_S = summer_survival$S3_conv,
#oat dynamics   
  poh_O = fall_tillage$O3_conv,
   ow_O = overwinter$O3_conv,
   prt_O  = spring_tillage$O3_conv,
   em_O  = emergence$O3_conv,
   sv_O = summer_survival$O3_conv)
}

N_3yr_conv_df <-  N_3yr_conv %>% 
  unlist(recursive = FALSE) %>%
  data.frame() %>%
    dplyr::rename(counts = ".") %>%
  dplyr::mutate(category = rep(c("seed_top", "seed_bottom", "cohort_1", "cohort_2", "cohort_3", "cohort_4", "cohort_5", "cohort_6"),t)) %>%
    filter(category %in% c("seed_top", "seed_bottom")) %>%
 # dplyr::select(!rowname) %>%
 # tidyr::pivot_wider(names_from = category,
#                    values_from = no_,
#                     values_fn = list) %>% 
    unnest(cols = everything() ) %>%
    mutate(cycle_no = rep(1:t, each = 2)) %>%
  group_by(category) %>%
  mutate(lambda_cycle = counts/lag(counts),
         lambda_annualized = nthroot(lambda_cycle,3)) %>%
    na.omit()
```
 