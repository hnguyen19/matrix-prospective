---
output:
    bookdown::word_document2:
      toc: false
      fig_caption: yes
#    reference_docx: style_template.docx
bibliography: WH-pop-dynamics.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readr)
library(emmeans)
library(here)
library(nlme)
library(flextable)
```


```{r seedbank-19, include=FALSE}
## Read (female) seed column data (from /AMATA-demography/4-Analysis/seedbank-fates-2014-through-2019.Rmd at chunk seed-column-19) 
 seed_column <- readRDS("../2-Data/Raw/seed-column-2019-list.RData")

#seed_column_df <- readRDS("../2-Data/Raw/seed-column-2019-df.RData")

seed_column_round <- readRDS("../2-Data/Raw/seed-column-2019-list-poisson.RData")
## To track possible errors, the seed columns are multiplied by each matrix step-by-step
```

The seed column before post-harvest tillage was transitioned from post-harvest tillage through spring tillage with the general form of $A_{h+1} = A_hN_h$ by @caswellMatrixPopulationModels2001.  

```{r post-harvest-tillage, include=FALSE}
## Raw data from 'FLOW-literature-based-matrices'
mean_post_harvest_tillage <- readRDS("../2-Data/Clean/mean-post-harvest-tillage.RData")

mean_post_harvest_tillage_pop <- purrr::map2(mean_post_harvest_tillage, seed_column, `%*%`)
```

```{r overwinter-seed-survival, include=FALSE}
## Scenario 1 - Sosnoskie et al., 2013
mean_overwinter_scenario1 <- readRDS("../2-Data/Clean/mean-winter-seed-survival-Sosnoskie.RData")

mean_over_winter_pop_scenario1 <- purrr::map2(mean_overwinter_scenario1, mean_post_harvest_tillage_pop, `%*%`)
```

```{r spring-tillage, include=FALSE}
## Load spring tillage matrices
mean_spring_tillage <-  readRDS("../2-Data/Clean/mean-pre-planting-tillage.RData")

## Apply spring tillage on overwinter-ed seed columns under the condition reported by Sosnoskie et al. 2013
mean_after_spring_tillage_pop_scenario1 <- purrr::map2(mean_spring_tillage, mean_over_winter_pop_scenario1, `%*%`)

## Keep the non-zeros in the 8x1 columns only, making a set of 2x1 columns
mean_after_spring_tillage_pop_scenario1_2by1 <- mean_after_spring_tillage_pop_scenario1   %>%
  map(~ head(.,2))

```


```{r top-stratum-after-spring-tillage}

### Write the top stratum of the newly shuffled seed columns (from fall tillage through spring tillage) into a dummy matrix
# https://community.rstudio.com/t/extract-matrix-rows-from-list/19357/2
#https://stackoverflow.com/questions/29511215/convert-row-names-into-first-column

mean_after_spring_tillage_pop_scenario1_top_stratum_df <- mean_after_spring_tillage_pop_scenario1  %>%
  map(~.x[1, ])  %>% 
  unlist(use.names = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column("matrix_id") %>% 
  rename(top_stratum_density = ".") %>%
  mutate(top_stratum_female_density = top_stratum_density/2) #assume 1:1 male:female


#mean_after_spring_tillage_pop_scenario1_dummy <-  lapply(split(mean_after_spring_tillage_pop_scenario1_df, mean_after_spring_tillage_pop_scenario1_df$matrix_id),
#       function(x)(matrix(x$top_stratum_density, nrow = 6)))

mean_after_spring_tillage_pop_scenario1_bottom_stratum_df <- mean_after_spring_tillage_pop_scenario1  %>%
  map(~.x[2, ])  %>% 
  unlist(use.names = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column("matrix_id") %>% 
  rename(bottom_stratum_density = ".") %>%
  mutate(bottom_stratum_female_density = bottom_stratum_density/2)

```

```{r emergence-20-density-matrix, include=FALSE}
## 2020 Emergence density, non-integers, from AMATA-demography/female-emergence chunk emerge-20-emm-df

#New, in dataframe format: 
female_emerge_20_mean_df <- readRDS("../2-Data/Raw/six-cohort-female-emerge-df-2020-raw.RData")

# Old: emerge_20 <- readRDS("../2-Data/Raw/six-cohort-female-emerge-list-2020-raw.RData")

## Turn the emerge_20_mean_df to wide format 
female_emerge_20_mean_wide <- female_emerge_20_mean_df %>%
  pivot_wider(names_from = Cohort, values_from = response)
```


**include in the matrix assembly section**

5% of the waterhemp seeds in a soil seedbank of 5 cm deep that was undisturbed mechanically in the first burial year and unexposed to herbicides throughout the experiment, emerged a year after seed burial [@buhlerEmergencePersistenceSeed2001]. Annually, 23.5% +/- 16.6% sd of waterhemp seeds that were not treated with herbicides and undisturbed mechanically emerged from the top 1 cm soil layer [@schutteCommonWaterhempAmaranthus2014]. 


Mesotrione applied at 75 g ha$^-1$ rate was 76% and 96% efficacious against *A retroflexus* L grown in corn that were susceptible and resistant to atrazine, respectively [@sutton2002activity]. On average, the Thiencarbazone-methyl + isoxaflutole mixture was 93.5% efficacious and mesotrione was 70.75% efficacious against *A. palmeri* grown in corn [@janak2016weed]. 


We combined the findings on other *Amaranthus* species from @sutton2002activity; @janak2016weed for herbicide efficacy and from @buhlerEmergencePersistenceSeed2001 and @schutteCommonWaterhempAmaranthus2014 for herbicide-unexposed germinants' emergence and set a uniform germination rate in all the crop identity crossed with corn weed management at 20%. The remaining seedbank density in the 0 - 2 cm soil stratum is calculated using the following equation: 

$$
N_{B_{e,11}} = (1 - G)*N_{B_{st,11}} = (1 - (E + D)) * N_{B_{st,11}}
$$
where,  
$N_{B_{e,11}}$ is the remaining seedbank density after seed germination
$N_{B_{st,11}}$ is the seed density in the top 0 - 2 cm soil stratum upon completion of pre-planting tillage
$G$ is the proportion of germinated seeds 
$E$ is the proportion of germinated seeds that successfully emerge as seedlings 
$D$ is the proportion of germinated seeds that were killed by weed control measures

$1 - G = 0.8$ is filled in the [1,1] position of the seedling recruitment matrix ($B_e[1,1]$).  


The resistance profile of waterhemp at our experiment site was undetermined, but the raw estimation of seedling emergence proportion with respect to the top 0 - 2 cm soil seedbank density seems unrealistically low (Table \@ref(tab:emerge-prop-tab). The cohort-specific emergence rates ($e_1$ through $e_6$) were adjusted from the raw data ($\frac{p_k}{N_{B_{st,11}}}$ with $k = \{1,...,6\}$) to reflect 5% emergence success rate (equivalent to $E = 0.01 * N_{B_{st,11}}$) in crop environments that received pre-emergence herbicides (C2, C3 and C4 under conventional weed management and all the S2, S3, and S4 [Table 1, @nguyenWeedCommunityComposition2022]), 100% emergence success rate (equivalent to $E = 1 * N_{B_{st,11}}$) in the crop environments that received post-emergence herbicides (C2, C3 and C4 under low herbicide weed management, [Table 1, @nguyenWeedCommunityComposition2022]) and 50% emergence success rate (equivalent to $E = 0.1 * N_{B_{st,11}}$).  





```{r emerge-prop-tab, echo=FALSE}
#Reality check of emergence proportion
# merge whole-column seed density with top stratum density
female_emerge_prop_20 <- female_emerge_20_mean_wide %>% 
  left_join(mean_after_spring_tillage_pop_scenario1_top_stratum_df, by = "matrix_id") %>%
  left_join(mean_after_spring_tillage_pop_scenario1_bottom_stratum_df, by = "matrix_id") %>%
  mutate(whole_seedbank_female_density = top_stratum_female_density + bottom_stratum_female_density) %>%
  mutate(cohort1_mean_prop_wrt_top = `1`/top_stratum_female_density,
         cohort2_mean_prop_wrt_top = `2`/top_stratum_female_density,
         cohort3_mean_prop_wrt_top = `3`/top_stratum_female_density,
         cohort4_mean_prop_wrt_top = `4`/top_stratum_female_density,
         cohort5_mean_prop_wrt_top = `5`/top_stratum_female_density,
         cohort6_mean_prop_wrt_top = `6`/top_stratum_female_density,
         cohort1_mean_prop_wrt_whole = `1`/whole_seedbank_female_density,
         cohort2_mean_prop_wrt_whole = `2`/whole_seedbank_female_density,
         cohort3_mean_prop_wrt_whole = `3`/whole_seedbank_female_density,
         cohort4_mean_prop_wrt_whole = `4`/whole_seedbank_female_density,
         cohort5_mean_prop_wrt_whole = `5`/whole_seedbank_female_density,
         cohort6_mean_prop_wrt_whole = `6`/whole_seedbank_female_density) %>%
  mutate(total_emerged_prop_wrt_top = cohort1_mean_prop_wrt_top + 
           cohort2_mean_prop_wrt_top + 
           cohort3_mean_prop_wrt_top + 
           cohort4_mean_prop_wrt_top + 
           cohort5_mean_prop_wrt_top +
           cohort6_mean_prop_wrt_top,
         total_emerged_prop_wrt_whole = cohort1_mean_prop_wrt_whole + 
           cohort2_mean_prop_wrt_whole + 
           cohort3_mean_prop_wrt_whole + 
           cohort4_mean_prop_wrt_whole + 
           cohort5_mean_prop_wrt_whole +
           cohort6_mean_prop_wrt_whole) %>% # estimated emergence rate  
  mutate(assumed_germination_rate = 0.2,
         assumed_successful_emergence_rate = ifelse(Crop_ID %in% c("O4", "O3", "A4"), 0.5, "NA")) 

female_emerge_prop_20$assumed_successful_emergence_rate[c(3, 5, 7, 13:18)] <- 0.05
female_emerge_prop_20$assumed_successful_emergence_rate[c(4,6,8)] <- 1

female_emerge_prop_20$assumed_successful_emergence_rate <- as.numeric( female_emerge_prop_20$assumed_successful_emergence_rate)

# View(female_emerge_prop_20)
# table of arithmetic means


### arrange rows by rotation 

female_emerge_prop_20_adjusted <- female_emerge_prop_20 %>% 
  mutate(assumed_successful_emergence_rate_from_seed = assumed_successful_emergence_rate*assumed_germination_rate,
         adjuster_ = assumed_successful_emergence_rate_from_seed / total_emerged_prop_wrt_top) %>%
  mutate(adjusted_total_emerged_prop_wrt_whole = total_emerged_prop_wrt_whole*adjuster_,
         adjusted_total_emerged_prop_wrt_top = total_emerged_prop_wrt_top*adjuster_)  %>%
   mutate(Rotation = ifelse(str_detect(Crop_ID,"2"), "2-year",
                           ifelse(str_detect(Crop_ID,"3"), "3-year", "4-year"))) %>%
   mutate(phase_order = ifelse(str_detect(Crop_ID, "C"), 1,
                              ifelse(str_detect(Crop_ID, "S"), 2,
                                     ifelse(str_detect(Crop_ID, "O"), 3, 4)))) %>%
  arrange(Rotation, phase_order, Corn_weed_management) %>%
  
   mutate(Corn_weed_management = ifelse(Corn_weed_management == "conv",
                                        paste0(Corn_weed_management,"entional"), "low")) 




female_emerge_prop_20_adjusted  %>%
  mutate_if(is.numeric, round, 4) %>%
  select(Crop_ID, Corn_weed_management, 
         total_emerged_prop_wrt_top, 
         total_emerged_prop_wrt_whole, 
         adjuster_,
         adjusted_total_emerged_prop_wrt_top,
         adjusted_total_emerged_prop_wrt_whole) %>%
flextable() %>%
  set_caption("Estimated and adjusted seedling emergence proportion with respect to the top 0 - 2 cm soil stratum and the whole seedbank (20 cm deep) using 2019 stratified soil seedbank densities and 2020 seedling emergence densities.") %>%
  set_header_labels(values = list(Crop_ID = "Crop ID",
                Corn_weed_management = "Corn weed management",
               total_emerged_prop_wrt_top = "top 0 - 2 cm",
                total_emerged_prop_wrt_whole = "whole seedbank",
               adjuster_ = "adjuster",
               adjusted_total_emerged_prop_wrt_top = "top 0 - 2 cm",
                adjusted_total_emerged_prop_wrt_whole = "whole seedbank")) %>%
  add_header_row(top = TRUE, values = c(" ", " ", 
                                        "Estimated total emergence proportion from",
                                        " ",
                                        "Adjusted total emergence proportion from"), 
                 colwidths = c(1, 1, 2, 1,  2)) %>%
   autofit() 

```

```{r recruitment-matrix-adjusted} 
# Multiply the raw with the adjuster
female_emerge_prop_20_adjusted_df <- female_emerge_prop_20_adjusted  %>%
  select(matrix_id, adjuster_,
         cohort1_mean_prop_wrt_top : cohort6_mean_prop_wrt_top,
         cohort1_mean_prop_wrt_whole : cohort6_mean_prop_wrt_whole) %>%
  mutate(adjusted_cohort1_mean_prop_wrt_top = adjuster_*cohort1_mean_prop_wrt_top,
         adjusted_cohort2_mean_prop_wrt_top = adjuster_*cohort2_mean_prop_wrt_top,
         adjusted_cohort3_mean_prop_wrt_top = adjuster_*cohort3_mean_prop_wrt_top,
         adjusted_cohort4_mean_prop_wrt_top = adjuster_*cohort4_mean_prop_wrt_top,
         adjusted_cohort5_mean_prop_wrt_top = adjuster_*cohort5_mean_prop_wrt_top,
         adjusted_cohort6_mean_prop_wrt_top = adjuster_*cohort6_mean_prop_wrt_top,
         adjusted_cohort1_mean_prop_wrt_whole = adjuster_*cohort1_mean_prop_wrt_whole,
         adjusted_cohort2_mean_prop_wrt_whole = adjuster_*cohort2_mean_prop_wrt_whole,
         adjusted_cohort3_mean_prop_wrt_whole = adjuster_*cohort3_mean_prop_wrt_whole,
         adjusted_cohort4_mean_prop_wrt_whole = adjuster_*cohort4_mean_prop_wrt_whole,
         adjusted_cohort5_mean_prop_wrt_whole = adjuster_*cohort5_mean_prop_wrt_whole,
         adjusted_cohort6_mean_prop_wrt_whole = adjuster_*cohort6_mean_prop_wrt_whole,
         top_mean_remain_prop = 1 - (adjusted_cohort1_mean_prop_wrt_top +
                                     adjusted_cohort2_mean_prop_wrt_top + 
                                     adjusted_cohort3_mean_prop_wrt_top +
                                     adjusted_cohort4_mean_prop_wrt_top + 
                                     adjusted_cohort5_mean_prop_wrt_top + 
                                     adjusted_cohort6_mean_prop_wrt_top))


### Mean matrix list 
female_emerge_prop_20_adjusted_df_long <- female_emerge_prop_20_adjusted_df %>%
  select(matrix_id, adjusted_cohort1_mean_prop_wrt_top:adjusted_cohort6_mean_prop_wrt_top) %>%
  pivot_longer(!matrix_id, names_to = "Cohort", values_to = "adjusted_mean_emerge_prop")



female_emerge_prop_20_adjusted_list <- lapply(split(female_emerge_prop_20_adjusted_df_long, female_emerge_prop_20_adjusted_df_long$matrix_id),
       function(x) rbind(cbind(matrix(c(0.8, 0,0,1), nrow = 2, byrow = TRUE), matrix(0,nrow = 2, ncol = 6)),
       cbind(matrix(x$adjusted_mean_emerge_prop, nrow = 6, ncol = 1),matrix(0,nrow =6, ncol=7))))

### Save adjusted emergence list  
# saveRDS(female_emerge_prop_20_adjusted_list, file="../2-Data/Clean/adjusted-mean-emergence-prop.RData")

```

